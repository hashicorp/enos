name: PR_build

on:
  # Runs when a pull request is created against main branch
  pull_request:
    branches:
      - main

env:
  PKG_NAME: "enos"

jobs:
  # build-artifact:
  #   name: Build Linux Artifact
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       go: [1.18]
  #       goos: [linux]
  #       goarch: [amd64]
  #     fail-fast: true
  #   outputs:
  #     artifact-name: ${{ steps.build.outputs.artifact-name }}
  #   env:
  #     GOPRIVATE: 'github.com/hashicorp/*'
  #     TOKEN: ${{ secrets.ELEVATED_GITHUB_TOKEN }}
  #     GOOS: ${{ matrix.goos }}
  #     GOARCH: ${{ matrix.goarch }}
  #     CI: true
  #   steps:
  #     - name: Setup go
  #       uses: actions/setup-go@v2
  #       with:
  #         go-version: '^1.18.0'
  #     - name: Checkout
  #       uses: actions/checkout@v2
  #     - name: Get Product Version
  #       id: get-product-version
  #       run: |
  #         make version
  #         echo "::set-output name=product-version::$(make version)"
  #     - name: Go ${{ matrix.go }} ${{ matrix.goos }} ${{ matrix.goarch }} build
  #       id: build
  #       run: |
  #         mkdir dist out
  #         make build-race
  #         zip -r -j out/${{ env.PKG_NAME }}_${{ steps.get-product-version.outputs.product-version }}_${{ matrix.goos }}_${{ matrix.goarch }}.zip dist/
  #         echo "::set-output name=artifact-name::${{ env.PKG_NAME }}_${{ steps.get-product-version.outputs.product-version }}_${{ matrix.goos }}_${{ matrix.goarch }}.zip"
  #     - name: Upload
  #       uses: actions/upload-artifact@v2
  #       with:
  #         name: ${{ env.PKG_NAME }}_${{ steps.get-product-version.outputs.product-version }}_${{ matrix.goos }}_${{ matrix.goarch }}.zip
  #         path: out/${{ env.PKG_NAME }}_${{ steps.get-product-version.outputs.product-version }}_${{ matrix.goos }}_${{ matrix.goarch }}.zip
  #         retention-days: 1

  # validate-artifact:
  #   name: Validate Artifact
  #   needs: build-artifact
  #   # Use local path to call reusable workflow validate.yml.
  #   uses: ./.github/workflows/validate.yml
  #   with:
  #     artifact-name: ${{ needs.build-artifact.outputs.artifact-name }}
  #   secrets:
  #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #     ENOS_CI_SSH_PRIVATE_KEY: ${{ secrets.ENOS_CI_SSH_PRIVATE_KEY }}

  create_release:
    runs-on: ubuntu-latest
    env:
      GOPRIVATE: 'github.com/hashicorp/*'
      GITHUB_TOKEN: ${{ secrets.ELEVATED_GITHUB_TOKEN }}
      ARTIFACTORY_TOKEN: ${{ secrets.QUALITY_TEAM_ARTIFACTORY_TOKEN }}
      ARTIFACTORY_USER: ${{ secrets.QUALITY_TEAM_ARTIFACTORY_USER }}
      # PRODUCT: ${{ github.event.repository.name }}
      # SHA: ${{ github.event.inputs.sha }}
      # VERSION: ${{ github.event.inputs.version }}
      # CHANNEL: ${{ github.event.inputs.channel }}
      # PRE_RELEASE: ${{ github.event.inputs.pre_release }}
      PRODUCT: enos
      SHA: 7f6e15ebe2a79e862113502dc576660b70629823
      VERSION: 0.0.0
      CHANNEL: stable
      PRE_RELEASE: false

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # Set up bob CLI
      - name: Setup bob CLI
        uses: hashicorp/action-setup-bob@v1
        with:
          github-token: ${{ secrets.ELEVATED_GITHUB_TOKEN }}

      # Use bob to download artifacts from Artifactory
      - name: Download artifacts
        run: |
          bob download artifactory \
          -token=${{ secrets.QUALITY_TEAM_ARTIFACTORY_TOKEN }} \
          -user=${{ secrets.QUALITY_TEAM_ARTIFACTORY_USER }} \
          -channel ${{ env.CHANNEL }} \
          -commit=${{ env.SHA }} \
          -product-name=${{env.PRODUCT }} \
          -product-version=${{ env.VERSION }} \
          -pattern="${{ env.PRODUCT }}_${{ env.VERSION }}_*_*.zip"

      # Confirm that artifacts have been downloaded
      - name: Confirm
        run: ls .bob/artifacts

      # Create a release. If `pre-release` box is checked:
      # Add the `--pre-release` flag to the `gh release create` command, and
      # create a pre-release tag with the format `v<version>-pre+<first 5 characters of SHA>`
      - name: Create release
        run: |
          TAG=v${{ env.VERSION }}
          PRERELEASE=""
          if [ ${{ env.PRE_RELEASE }} = true ]; then
            PRERELEASE="--prerelease"
            TAG=v${{ env.VERSION }}-pre+$( echo ${{ env.SHA }} | head -c 5 )
          fi
          gh release create $TAG --target ${{ env.SHA }} --generate-notes $PRERELEASE ./.bob/artifacts/*.zip
